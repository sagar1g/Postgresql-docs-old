ğŸ§  Detailed explanation of how a SELECT query vs. an INSERT/UPDATE/DELETE query flows through PostgreSQL internals, especially involving:

1.Shared Buffers

2.WAL

3.WAL Writer

4.Background Writer

5.Checkpointer

6. Archiver

==============================================================================================================

Letâ€™s break it into two flows:

ğŸ” FLOW 1: SELECT Query (Read-only)
Example:

SELECT * FROM emp WHERE empid = 101;


ğŸ” What Happens Internally:

Step	Component	Action

1ï¸âƒ£	Client	Sends the SELECT query to PostgreSQL

2ï¸âƒ£	Parser/Planner	SQL is parsed & query plan is generated

3ï¸âƒ£	Executor	Executes the query plan

4ï¸âƒ£	Shared Buffers	PostgreSQL checks if the emp table page is already loaded in shared buffers

5ï¸	        âœ”ï¸ If present, reads from memory (fast)
6ï¸	        âŒ If not present, reads from disk and loads into Shared Buffers

7ï¸âƒ£	Result	Rows are sent back to the client

ğŸ’¡ Important Notes:

SELECT queries do NOT write anything, so:

âŒ No WAL entry

âŒ No background writer

âŒ No checkpointer

âŒ No archiver


âœ… It only uses Shared Buffers and possibly disk I/O (if data isn't cached)

==========================================================================================================================

âœï¸ FLOW 2: INSERT / UPDATE / DELETE Query (Write)
Letâ€™s take this UPDATE example:

UPDATE emp SET salary = 70000 WHERE empid = 101;


ğŸ” What Happens Internally:

Step	Component	Action

1ï¸âƒ£	Client	Sends the UPDATE query

2ï¸âƒ£	Parser/Planner	SQL is parsed and a plan is made

3ï¸âƒ£	Executor	Executes the plan

4ï¸âƒ£	Shared Buffers	PostgreSQL loads the data block into memory (Shared Buffers) if not already loaded

5ï¸âƒ£		The data block is modified (new salary written in memory)

6ï¸âƒ£	WAL Buffer	WAL entry is created to describe this change and written to WAL buffer

7ï¸âƒ£	WAL Writer	Periodically writes WAL buffer to pg_wal/ directory (persistent disk)

8ï¸âƒ£	Background Writer (bgwriter)	Periodically flushes dirty pages (changed blocks) from Shared Buffers to actual table file on disk

9ï¸âƒ£	Checkpointer	At checkpoint, it forces all dirty pages and WAL sync to disk. Records checkpoint location

ğŸ”Ÿ	Archiver	If WAL file (16MB) is completed, archiver runs archive_command to copy file from pg_wal/ to archive dir


ğŸ§  Key Points:
Component	    Used in SELECT?	 Used in UPDATE/INSERT/DELETE?
Shared Buffers	    âœ… Yes	        âœ… Yes
WAL Buffer	        âŒ No	        âœ… Yes
WAL Writer	        âŒ No	        âœ… Yes
Background Writer	âŒ No	        âœ… Yes
Checkpointer	    âŒ No	        âœ… Yes
Archiver	        âŒ No	        âœ… Yes (when WAL segment closes)


ğŸ”„ Timeline of Events (Write Query):

Update runs â Page modified in Shared Buffers
        â WAL record created in memory (WAL buffer)
        â WAL Writer writes to pg_wal/
        â Background Writer flushes dirty page to table
        â Checkpointer flushes all for a checkpoint
        â Archiver archives WAL segment if it's closed
		
		
ğŸ“ Real Files on Disk Affected:


Type	            Path	                                   Example
WAL File	       pg_wal/	                                 0000000100000000000000A1

Table Data File	   base/<dbid>/<relfilenode>	             Physical file holding emp table

Archived WAL	   archive dir (via archive_command)	      /mnt/backup/0000000100000000000000A1


ğŸ” Monitoring View
You can use system views to monitor everything:

Component	            View
WAL stats	         pg_stat_wal
Archiver stats	    pg_stat_archiver
Checkpoint info	    pg_stat_bgwriter
Buffers & I/O	    pg_stat_io, pg_buffercache (extension)


ğŸ“Œ Summary Comparison
Feature	                SELECT	                             INSERT / UPDATE / DELETE
Shared Buffers	        âœ… Yes	                               âœ… Yes
WAL	                   âŒ No	                               âœ… Yes
Disk Writes	           âŒ Rare (only if page not cached)	   âœ… Yes (bgwriter, checkpointer)
Archiving	           âŒ No	                               âœ… Yes (if WAL file is closed)
